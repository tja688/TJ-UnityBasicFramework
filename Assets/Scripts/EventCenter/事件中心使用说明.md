# EventCenter（事件中心）使用说明

本工具位于 `Assets/Scripts/EventCenter`，核心 API 在 `Assets/Scripts/EventCenter/Core/EventCenter.cs`，事件名定义在 `Assets/Scripts/EventCenter/Core/EventName.cs`。

## 0. 快速心智模型

- **事件名**：用 `EventName`（一个 `enum`）做全局唯一标识。
- **订阅/取消订阅**：`EventCenter.AddListener(...)` / `EventCenter.RemoveListener(...)`。
- **发布事件**：`EventCenter.TriggerEvent(...)`。
- **不需要显式“注册”**：第一次 `AddListener` 会把该事件写入内部表；未注册/无监听的 `TriggerEvent` 会直接返回。
- **强约束**：同一个 `EventName` 的监听签名（参数数量/类型）必须一致，否则会抛 `EventCenterException`。

> 代码使用前在脚本顶部添加：`using FlyRabbit.EventCenter;`

---

## 1. 创建 / 删除事件（给 AI agents 的操作要点）

### 创建事件（推荐流程）

1. 打开 `Assets/Scripts/EventCenter/Core/EventName.cs`
2. 在 `public enum EventName` 里新增一个枚举项（PascalCase 命名）
3. **按 Example 的格式写 XML 注释**：在 `<remarks>` 里用 `<list>` 列出每个参数的“类型 + 含义”

最小示例（1 个参数）：

```csharp
/// <summary>
/// 玩家金币变化
/// </summary>
/// <remarks>
/// <list type="bullet">
/// <item><description>参数1：int→当前金币</description></item>
/// </list>
/// </remarks>
PlayerGoldChanged,
```

无参数事件（0 个参数）示例：

```csharp
/// <summary>
/// 玩家死亡
/// </summary>
/// <remarks>
/// <list type="bullet">
/// </list>
/// </remarks>
PlayerDied,
```

### 删除事件

- 在 `Assets/Scripts/EventCenter/Core/EventName.cs` 删除对应枚举项。
- 全项目搜索该事件名（`EventName.XXX`）并一并删除/替换相关 `AddListener/RemoveListener/TriggerEvent` 调用（否则会编译失败）。

### 弃用事件（不想立刻删）

- 给枚举项加 `[Obsolete("原因/替代方案", false)]`（示例见 `Example`）。

---

## 2. 订阅事件 / 取消订阅（AddListener / RemoveListener）

### 推荐写法（Unity 生命周期成对出现）

无参数：

```csharp
private void OnEnable()
{
    EventCenter.AddListener(EventName.PlayerDied, OnPlayerDied);
}

private void OnDisable()
{
    EventCenter.RemoveListener(EventName.PlayerDied, OnPlayerDied);
}

private void OnPlayerDied()
{
    // ...
}
```

一个参数：

```csharp
private void OnEnable()
{
    EventCenter.AddListener<int>(EventName.PlayerGoldChanged, OnGoldChanged);
}

private void OnDisable()
{
    EventCenter.RemoveListener<int>(EventName.PlayerGoldChanged, OnGoldChanged);
}

private void OnGoldChanged(int gold)
{
    // ...
}
```

两个参数（同理最多支持 5 个参数）：

```csharp
EventCenter.AddListener<int, string>(EventName.SomeEvent, OnSomeEvent);
EventCenter.RemoveListener<int, string>(EventName.SomeEvent, OnSomeEvent);

private void OnSomeEvent(int a, string b) { }
```

### 注意事项（AI agents 常犯）

- `RemoveListener` **必须传入同一个方法引用**；不要直接用匿名 lambda：
  - 错误示例：`AddListener(..., () => {...}); RemoveListener(..., () => {...});`（两次 lambda 不是同一个委托实例）
  - 需要用 lambda 时：把委托保存成字段再 Add/Remove。
- 同一 `EventName` 的监听签名必须一致：如果先用 `AddListener<int>`，后面就不能再对同一个事件用 `AddListener<string>`。

---

## 3. 发布事件（TriggerEvent）

无参数：

```csharp
EventCenter.TriggerEvent(EventName.PlayerDied);
```

一个参数：

```csharp
EventCenter.TriggerEvent<int>(EventName.PlayerGoldChanged, gold);
```

两个参数（同理最多支持 5 个参数）：

```csharp
EventCenter.TriggerEvent<int, string>(EventName.SomeEvent, a, b);
```

建议：当参数很多/类型复杂时，用一个 `struct/class` 作为单一参数（更易维护，避免“最多 5 个参数”的限制）。

---

## 4. 行为与报错

- 未注册事件或无监听：`TriggerEvent` 直接返回（不报错）。
- 监听为 `null`、签名不匹配：会抛 `FlyRabbit.EventCenter.EventCenterException`（由 `EventCenter.cs` 的 `ReportError` 触发）。
- 移除未注册/无监听事件：`RemoveListener` 直接返回（不报错）。
- 需要清理空事件键：可调用 `EventCenter.ClearEmptyEvent()`（一般不必）。

---

## 5. 辅助工具（可选）

- **事件查看器**：Unity 菜单 `FlyRabbit/Event Center/事件查看器`  
  会扫描项目中 `EventCenter.AddListener/RemoveListener/TriggerEvent` 的调用位置，便于排查哪里在用某个事件。

- **EventCenterVoidEventRelay（仅无参事件）**：`Assets/Scripts/EventCenter/Core/EventCenterVoidEventRelay.cs`  
  挂到物体上后，可在 Inspector 里选择一个 `EventName`，当该事件触发时调用一个 `UnityEvent`。  
  该组件只会监听“文档参数个数为 0”的事件（依赖 `EventName.cs` 注释里的 `<item>` 数量判断）。

