# FEEL Core Scripts Architecture (MMFeedbacks)

## Directory map
- **MMFeedbacks/Core** – base runtime layer (player, feedback base class, timing, helper events) that drives every feedback instance.
- **MMFeedbacks/Feedbacks** – concrete feedback implementations (animation, audio, transforms, particles, DOTween bindings, etc.).
- **MMFeedbacks/Shakers & Springs** – runtime responders (camera/transform shakers, spring utilities) that often consume channel events emitted by feedbacks.
- **MMFeedbacks/Editor** – custom inspectors and editor utilities (not detailed here; focus is on runtime plumbing you will wrap with new UI/UX).

## Player pipeline (MMF_Player)
- **Component role**: `MMF_Player` is the modern player that replaces the legacy `MMFeedbacks` list. It stores a `FeedbacksList` of `MMF_Feedback` instances and exposes the player-level `TotalDuration` from a cached computation so editor tooling can query timing cheaply.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Player.cs†L17-L46】
- **Lifecycle**: Auto-init is configurable (Awake/Start/OnEnable). Awake seeds helper components (e.g., auto re-enabler when `AutoPlayOnEnable` is true), checks for loops, pre-initializes feedbacks, and caches total duration.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Player.cs†L50-L160】
- **Play entry**: Public `PlayFeedbacks` overloads all route to `PlayFeedbacksInternal`, which guards with `AutoInitialization`, `IsAllowedToPlay` (chance, cooldown, range, already playing), direction switching, feedback reset, timestamping, optional initial delay, and then prepares playback. This is where timeline tools should hook to respect playability rules before scheduling clips.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Player.cs†L333-L396】
- **Stop/Reset**: `StopFeedbacks` optionally stops every feedback, clears the playing flag; `ResetFeedbacks` calls each feedback’s `ResetFeedback` and clears the playing flag—useful for preview reset or scrubber rollback logic.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Player.cs†L780-L818】
- **Duration cache**: `ComputeCachedTotalDuration` recomputes based on each feedback’s computed duration, respecting direction filters and pauses/loops. If no pauses are found it simply keeps the longest active feedback duration, else it walks pauses/loops to approximate sequence length. Use this to drive timeline span calculations instead of recomputing per frame.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Player.cs†L1548-L1584】

## Feedback base (MMF_Feedback)
- **Core settings**: Each feedback declares label, activation, channels (int or `MMChannel` asset), randomness groups (output and duration), range-based attenuation, automatic shaker setup hook, and target acquisition config. These are the knobs to surface in a new UI without digging into every concrete feedback.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Feedback.cs†L21-L186】
- **Timing model**: `Timing` (`MMFeedbackTiming`) holds per-feedback delays, cooldown, repeats, play-direction rules, intensity gates, and sequence binding. The base exposes `TotalDuration` = initial delay + duration + repeat gaps, recomputed via `ComputeTotalDuration()` with respect to `Timing.ContributeToTotalDuration`. Timeline tooling can rely on this to lay out clips and detect hidden gaps.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Feedback.cs†L323-L333】【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Feedback.cs†L1039-L1072】
- **Setup detection**: `CacheRequiresSetup()` calls `EvaluateRequiresSetup()` and considers auto target acquisition to flag missing references, caching human-readable requirement strings. Surfacing this flag in a new UI will prevent the current “silent failure” experience when enabling options hides parameters.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Feedback.cs†L337-L379】
- **Randomization & intensity**: `ComputeIntensity()` blends parent intensity, optional randomness, and range falloff; range support is driven by `UseRange`, `RangeDistance`, `UseRangeFalloff`, and remap values. Highlight these interactions in redesigned controls to avoid the silent attenuation traps in current inspectors.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Feedback.cs†L74-L120】【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Feedback.cs†L197-L216】

## Timing container (MMFeedbackTiming)
- Holds per-feedback timescale, delays, cooldown, repeat counts, play-direction conditions, intensity gates, and optional sequence binding. This is the single source for per-feedback scheduling data (initial delay, duration multiplier, repeat gap, etc.) when constructing a master timeline view.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMFeedbackTiming.cs†L9-L92】

## Practical entry points for customization
- **Timeline construction**: Use `MMF_Player.FeedbacksList` with each feedback’s `Timing` (initial delay, repeat delays, `FeedbackDuration` overrides) and cached `TotalDuration` to build per-clip spans. The player-level `ComputeCachedTotalDuration()` already accounts for pauses/loops, which is valuable for drawing total track length without replaying effects.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Player.cs†L17-L46】【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Player.cs†L1548-L1584】
- **Preview/reset workflow**: Invoking `ResetFeedbacks()` then `PlayFeedbacks()` mirrors the built-in preview pipeline; combine with `StopFeedbacks()` when scrubbing to ensure long-running feedbacks halt cleanly. The player exposes `KeepPlayModeChanges` and `PerformanceMode` for editor previews to decide between fidelity and speed.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Player.cs†L28-L46】【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Player.cs†L780-L818】
- **Detecting hidden option coupling**: When reworking inspectors, surface `HasChannel`, `HasRandomness`, `HasRange`, `HasAutomatedTargetAcquisition`, and `RequiresSetup` flags from the base class. They encode which option groups are meaningful for each derived feedback and prevent the current silent parameter invalidation when toggles disable values internally.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Feedback.cs†L153-L186】【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Feedback.cs†L337-L379】
- **Extensibility without source edits**: Many behaviours are data-driven (channels, randomness, range, timescale, repeats). Where deeper changes are required (e.g., new preview modes, different play guards), hooks like `PlayFeedbacksInternal`, `IsAllowedToPlay`, `ComputeTotalDuration`, and the virtual `FeedbackDuration`/`EvaluateRequiresSetup` can be overridden in subclasses or wrapper players to avoid patching every concrete feedback.【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Player.cs†L333-L396】【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Feedback.cs†L323-L379】【F:Assets/Plugins/Feel/MMFeedbacks/MMFeedbacks/Core/MMF_Player/MMF_Feedback.cs†L1039-L1072】

## Where to look next (per-feature)
- **Transform/animation feedbacks**: `MMFeedbacks/Feedbacks` folder holds concrete effects (position/rotation/scale, animation triggers, audio, VFX). Use the base flags above to spot which ones hide parameters when certain modes are enabled.
- **Channels and shakers**: `Core/MMChannels` and `Shakers` define the event bus and receivers—important if you plan to centralize routing in a new editor.
- **Pooling & helpers**: `Core/ObjectPool` and `MMFeedbacksHelpers` provide shared utilities for spawn-heavy feedbacks; consider exposing pool toggles in the new UI toolkit panels.

